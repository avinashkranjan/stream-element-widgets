<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Curved Music Widget</title>
    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <div class="widget">
      <img
        id="cover"
        class="cover"
        src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRGh5WFH8TOIfRKxUrIgJZoDCs1yvQ4hIcppw&s"
        alt="Album Art"
      />

      <!-- Gradient Overlay -->
      <div class="overlay"></div>

      <!-- Progress Arc -->
      <svg class="arc-bar" viewBox="0 0 300 150">
        <!-- Full white base arc -->
        <path
          d="M 30 130 Q 150 20 270 130"
          stroke="#ffffff"
          stroke-width="4"
          stroke-linecap="round"
          fill="none"
        />
        <!-- Yellow foreground progress -->
        <path
          id="progress-bar"
          d="M 30 130 Q 150 20 270 130"
          stroke="#f6c96b"
          stroke-width="4"
          stroke-linecap="round"
          fill="none"
          stroke-dasharray="420"
          stroke-dashoffset="420"
        />
        <!-- Knob -->
        <circle id="progress-knob" cx="30" cy="130" r="6" fill="#f6c96b" />
      </svg>

      <!-- Time -->
      <div class="time-container">
        <span id="current-time">0:00</span>
        <span id="total-time">3:40</span>
      </div>

      <!-- Info -->
      <div class="info">
        <div class="track" id="track">Track Title</div>
        <div class="artist" id="artist">Artist Name</div>
      </div>
    </div>

    <script>
      const trackElem = document.getElementById("track");
      const artistElem = document.getElementById("artist");
      const progressBar = document.getElementById("progress-bar");
      const coverImg = document.getElementById("cover");
      const albumElem = document.getElementById("album");
      const currentTimeElem = document.getElementById("current-time");
      const totalTimeElem = document.getElementById("total-time");
      const knob = document.getElementById("progress-knob");

      let lastTrack = "";
      let progress = 0; // seconds
      const duration = 220; // 3:40 in seconds
      const fullLength = 420;

      function fetchSnipData() {
        fetch("../Snip.txt")
          .then((res) => res.text())
          .then((data) => {
            console.log(data);
            const line = data.trim();
            const match = line.match(/“(.+?)”\s*―\s*(.+?)(?:,\s*(.+))?$/);

            if (match) {
              const [_, track, artist, album] = match;

              if (track !== lastTrack) {
                progress = 0;
                const coverUrl = "../Snip_Artwork.jpg";
                updateInfo(track, artist, album, coverUrl);
                lastTrack = track;
              }
            }
          })
          .catch((err) => console.error("Error reading Snip.txt:", err));
      }

      function updateInfo(track, artist, album, coverUrl) {
        if (trackElem) trackElem.textContent = track;
        if (artistElem) artistElem.textContent = artist;
        if (albumElem) albumElem.textContent = album;
        if (coverImg && coverUrl) {
          coverImg.crossOrigin = "Anonymous";
          coverImg.src = coverUrl;
        }
      }

      function updateProgress() {
        if (progress < duration) progress++;

        const percent = (progress / duration) * 100;
        const offset = fullLength - (fullLength * percent) / 100;
        progressBar.setAttribute("stroke-dashoffset", offset);

        const t = percent / 100;
        const pos = getQuadraticBezierXY(t, 30, 130, 150, 20, 270, 130);
        knob.setAttribute("cx", pos.x);
        knob.setAttribute("cy", pos.y);

        currentTimeElem.textContent = formatTime(progress);
        totalTimeElem.textContent = formatTime(duration);
      }

      function formatTime(sec) {
        const min = Math.floor(sec / 60);
        const s = sec % 60;
        return `${min}:${s.toString().padStart(2, "0")}`;
      }

      function getQuadraticBezierXY(t, sx, sy, cx, cy, ex, ey) {
        const x = (1 - t) ** 2 * sx + 2 * (1 - t) * t * cx + t ** 2 * ex;
        const y = (1 - t) ** 2 * sy + 2 * (1 - t) * t * cy + t ** 2 * ey;
        return { x, y };
      }

      setInterval(fetchSnipData, 2000);
      setInterval(updateProgress, 1000);
    </script>
  </body>
</html>
