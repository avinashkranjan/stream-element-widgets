<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.2/color-thief.umd.js"></script>
    <title>Now Playing Widget</title>
  </head>
  <body>
    <div id="player" class="widget">
      <img id="cover" class="cover" crossorigin="anonymous" />
      <div id="play-icon" class="play-icon"></div>
      <div class="info-container">
        <div class="info">
          <span id="track" class="track">Track Name</span>
          <span class="dot">•</span>
          <span id="artist" class="artist">Artist Name</span>
        </div>
        <div class="progress-wrapper">
          <div class="progress-bar" id="progress-bar"></div>
        </div>
      </div>
    </div>

    <script>
      const trackElem = document.getElementById("track");
      const artistElem = document.getElementById("artist");
      const coverImg = document.getElementById("cover");
      const progressBar = document.getElementById("progress-bar");
      const playIconElem = document.getElementById("play-icon");
      const playerElem = document.getElementById("player");

      let lastTrack = "";
      let progress = 0;
      const duration = 210;
      let isPlaying = false;

      const playIconSVG = `
      <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" width="24" height="24">
        <path fill-rule="evenodd" d="M4.5 5.653c0-1.427 1.529-2.33 2.779-1.643l11.54 6.347c1.295.712 1.295 2.573 0 3.286L7.28 19.99c-1.25.687-2.779-.217-2.779-1.643V5.653Z" clip-rule="evenodd"/>
      </svg>`;

      const pauseIconSVG = `
      <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24" width="24" height="24">
        <path fill-rule="evenodd" d="M6.75 5.25a.75.75 0 0 1 .75-.75H9a.75.75 0 0 1 .75.75v13.5a.75.75 0 0 1-.75.75H7.5a.75.75 0 0 1-.75-.75V5.25Zm7.5 0A.75.75 0 0 1 15 4.5h1.5a.75.75 0 0 1 .75.75v13.5a.75.75 0 0 1-.75.75H15a.75.75 0 0 1-.75-.75V5.25Z" clip-rule="evenodd"/>
      </svg>`;

      function setIcon() {
        playIconElem.innerHTML = isPlaying ? pauseIconSVG : playIconSVG;
      }

      function resetPlayer() {
        trackElem.textContent = "Track Name";
        artistElem.textContent = "Artist Name";
        progressBar.style.width = "0%";
        isPlaying = false;
        setIcon();
      }

      function fetchSnipData() {
        fetch("../Snip.txt")
          .then((res) => res.text())
          .then((data) => {
            const line = data.trim();
            if (!line) {
              resetPlayer();
              return;
            }

            const match = line.match(/“(.+?)”\s*―\s*(.+?)(?:,\s*(.+))?$/);
            if (!match) {
              resetPlayer();
              return;
            }

            const [_, track, artist] = match;

            if (track !== lastTrack) {
              lastTrack = track;
              progress = 0;
              isPlaying = true;
              trackElem.textContent = track;
              artistElem.textContent = artist;
              coverImg.src = "../Snip_Artwork.jpg?" + Date.now(); // avoid caching
              setIcon();
            }
          })
          .catch((err) => {
            console.error("Error reading Snip.txt:", err);
            resetPlayer();
          });
      }

      function updateProgress() {
        if (!isPlaying) return;

        if (progress < duration) progress++;
        const percent = (progress / duration) * 100;
        progressBar.style.width = `${percent}%`;

        if (progress >= duration) {
          isPlaying = false;
          setIcon();
        }
      }

      function pastelize(rgb) {
        let [h, s, l] = rgbToHsl(...rgb);
        return hslToRgb(h, 0.3, 0.85);
      }

      function brighten(rgb, amount = 0.4) {
        let [h, s, l] = rgbToHsl(...rgb);
        return hslToRgb(h, s, Math.min(1, l + amount));
      }

      function rgbToHsl(r, g, b) {
        r /= 255;
        g /= 255;
        b /= 255;
        const max = Math.max(r, g, b),
          min = Math.min(r, g, b);
        let h,
          s,
          l = (max + min) / 2;

        if (max === min) h = s = 0;
        else {
          const d = max - min;
          s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
          switch (max) {
            case r:
              h = (g - b) / d + (g < b ? 6 : 0);
              break;
            case g:
              h = (b - r) / d + 2;
              break;
            case b:
              h = (r - g) / d + 4;
              break;
          }
          h /= 6;
        }
        return [h * 360, s, l];
      }

      function hslToRgb(h, s, l) {
        h /= 360;
        const hue2rgb = (p, q, t) => {
          if (t < 0) t += 1;
          if (t > 1) t -= 1;
          if (t < 1 / 6) return p + (q - p) * 6 * t;
          if (t < 1 / 2) return q;
          if (t < 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
          return p;
        };
        const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
        const p = 2 * l - q;
        const r = hue2rgb(p, q, h + 1 / 3);
        const g = hue2rgb(p, q, h);
        const b = hue2rgb(p, q, h - 1 / 3);
        return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
      }

      function applyGradient() {
        if (!coverImg.complete || coverImg.naturalWidth === 0) return;
        try {
          const thief = new ColorThief();
          const dominant = thief.getColor(coverImg);
          const color1 = pastelize(dominant);
          const color2 = brighten(dominant, 0.4);
          playerElem.style.background = `linear-gradient(90deg, rgb(${color1}), rgb(${color2}))`;
          progressBar.style.background = `rgb(${color2})`;
        } catch {
          playerElem.style.background = "#eee";
        }
      }

      coverImg.addEventListener("load", applyGradient);

      setIcon();
      setInterval(fetchSnipData, 2000);
      setInterval(updateProgress, 1000);
    </script>
  </body>
</html>
